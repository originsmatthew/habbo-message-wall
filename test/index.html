<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Habbo Origins Wall of Kindness</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="header-placeholder"></div> <!-- Dynamic header placeholder -->

    <section class="intro-message-section">
      <div class="intro-message-container">
        <p class="intro-message">
          <u>Hey Habbos!</u><br>
          Matthew here. Let's spread some positivity! Simply <a href="add-message.html" class="link">leave a message</a> telling us something nice about a fellow Habbo.
          <br><br>
          The wall will be open for one week. On <u>Monday, 21st October</u>, every Habbo who has sent or received a message will be entered into a prize draw to win <a href="f02b6d15-e922-44be-95b7-1096926f3105.png" target="_blank" class="link">one of the prizes at random from this room</a>.
        </p>
        <p class="intro-details">
          That means we'll have <u>22 winners</u>! Each Habbo can only be entered once, regardless of how many times their name is mentioned.
        </p>
        <p class="thank-you-message">Thanks so much for taking part in our week of kindness. â™¡</p>
      </div>
    </section>

    <section>
      <h2>The Wall of Kindness</h2>
      <div id="messagesContainer">
        <p>Loading messages...</p>
      </div>

      <!-- Pagination -->
      <div id="pagination">
        <button id="prevPage" disabled>Previous</button>
        <span id="pageIndicator">Page 1</span>
        <button id="nextPage" disabled>Next</button>
      </div>
    </section>

    <div id="footer-placeholder"></div> <!-- Dynamic footer placeholder -->

    <script>
      function loadContent(selector, file) {
        fetch(file)
          .then(response => response.text())
          .then(data => {
            document.querySelector(selector).innerHTML = data;
          })
          .catch(error => console.error('Error loading content:', error));
      }

      loadContent('#header-placeholder', 'header.html');
      loadContent('#footer-placeholder', 'footer.html');

      let currentPage = 1;
      const messagesPerPage = 10;

      async function fetchMessages() {
        const airtableToken = "patJ1ygzZwHGdrzeE.086c49e787b3e28cf270914e240eade8279592e7f0aaa2206d7bc0fd41a29c11";
        const airtableBaseURL = "https://api.airtable.com/v0/app2r945tWexLP44Z/Messages";

        try {
          const response = await fetch(
            `${airtableBaseURL}?filterByFormula={Approved}=TRUE()`,
            {
              headers: {
                Authorization: `Bearer ${airtableToken}`,
                "Content-Type": "application/json",
              },
            }
          );
          const result = await response.json();
          const messages = result.records;

          messages.sort((a, b) => new Date(b.createdTime) - new Date(a.createdTime));

          const totalPages = Math.ceil(messages.length / messagesPerPage);
          displayMessages(messages, currentPage, totalPages);

          const prevButton = document.getElementById("prevPage");
          const nextButton = document.getElementById("nextPage");
          const pageIndicator = document.getElementById("pageIndicator");

          prevButton.disabled = currentPage === 1;
          nextButton.disabled = currentPage === totalPages;

          prevButton.onclick = () => {
            if (currentPage > 1) {
              currentPage--;
              displayMessages(messages, currentPage, totalPages);
              pageIndicator.innerText = `Page ${currentPage} of ${totalPages}`;
            }
          };

          nextButton.onclick = () => {
            if (currentPage < totalPages) {
              currentPage++;
              displayMessages(messages, currentPage, totalPages);
              pageIndicator.innerText = `Page ${currentPage} of ${totalPages}`;
            }
          };
        } catch (error) {
          console.error("Error fetching messages:", error);
          document.getElementById("messagesContainer").innerHTML = "<p>Failed to load messages.</p>";
        }
      }

      function displayMessages(messages, page, totalPages) {
        const container = document.getElementById("messagesContainer");
        container.innerHTML = "";

        const start = (page - 1) * messagesPerPage;
        const end = start + messagesPerPage;
        const messagesToShow = messages.slice(start, end);

        messagesToShow.forEach(message => {
          const yourHabbo = message.fields["Your Habbo Name"];
          const friendHabbo = message.fields["Friend Habbo Name"];
          const kindMessage = message.fields["Message"];
          const createdTime = new Date(message.createdTime);
          const submissionDate = createdTime.toLocaleDateString("en-GB");
          const submissionTime = createdTime.toLocaleTimeString("en-GB", {
            hour: "2-digit",
            minute: "2-digit",
            hour12: true,
          });

          const messageBox = `
            <div class="message-box">
              <div class="avatar-container">
                <div class="avatar sender">
                  <img src="https://habboera.com/imager?habbo=${yourHabbo}&size=l&gesture=std&action=wav&direction=2&head_direction=2&headonly=0" alt="${yourHabbo}">
                  <p>${yourHabbo}</p>
                </div>
                <div class="message-content">
                  <div class="pixel-message-container">
                    <div class="pixel-message">
                      <p>${kindMessage}</p>
                    </div>
                    <p class="submission-time">Submitted on: ${submissionDate} @ ${submissionTime} UTC</p>
                  </div>
                </div>
                <div class="avatar recipient">
                  <img src="https://habboera.com/imager?habbo=${friendHabbo}&size=l&gesture=std&action=wav&direction=4&head_direction=4&headonly=0" alt="${friendHabbo}">
                  <p>${friendHabbo}</p>
                </div>
              </div>
            </div>
          `;
          container.innerHTML += messageBox;
        });
      }

      fetchMessages();
    </script>
  </body>
</html>
